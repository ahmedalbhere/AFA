<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AFA - محلل القوائم المالية</title>
    <link rel="stylesheet" href="style.css">
    <style>
        /* إضافة الأنماط الجديدة داخل HTML كبديل */
        .ratio-interpretation {
            margin-top: 8px;
            font-size: 0.85rem;
            color: #a0a0a0;
            font-style: italic;
        }
        
        .cash-flow-summary {
            background-color: #16213e;
            border-radius: 8px;
            padding: 1.2rem;
            margin-top: 1.5rem;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .summary-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
            padding-bottom: 8px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        }
        
        .summary-item:last-child {
            border-bottom: none;
            margin-bottom: 0;
            padding-bottom: 0;
            font-weight: 600;
            font-size: 1.1rem;
        }
        
        /* تحسين عرض النسب في الشاشات الصغيرة */
        @media (max-width: 768px) {
            .ratio-interpretation {
                font-size: 0.8rem;
            }
            
            .summary-item {
                flex-direction: column;
                gap: 5px;
            }
        }
    </style>
</head>
<body>
    <header>
        <div class="container header-content">
            <div class="logo">AFA</div>
            <nav>
                <button class="mobile-menu-btn" id="mobile-menu-btn">☰</button>
                <ul id="nav-menu">
                    <li><a href="#">الرئيسية</a></li>
                    <li><a href="#">التحليل</a></li>
                    <li><a href="#">الأدوات</a></li>
                    <li><a href="#">المقالات</a></li>
                    <li><a href="#">اتصل بنا</a></li>
                </ul>
            </nav>
        </div>
    </header>

    <section class="hero">
        <div class="container">
            <h1>محلل القوائم المالية AFA</h1>
            <p>أدخل بيانات قائمة الدخل والميزانية العمومية لشركتك واحصل على تحليل شامل للنسب المالية والتدفقات النقدية وتقييم الأداء</p>
            <a href="#data-input" class="btn">ابدأ التحليل الآن</a>
        </div>
    </section>

    <div class="container">
        <section id="data-input" class="data-input-section">
            <h2 class="section-title">إدخال البيانات المالية</h2>
            <form id="financial-data-form">
                <div class="form-group">
                    <label for="company-name">اسم الشركة</label>
                    <input type="text" id="company-name" placeholder="أدخل اسم الشركة" required>
                </div>

                <div class="years-input">
                    <div class="form-group">
                        <label for="year1">السنة الأولى</label>
                        <input type="number" id="year1" value="2024" min="2000" max="2030">
                    </div>
                    <div class="form-group">
                        <label for="year2">السنة الثانية</label>
                        <input type="number" id="year2" value="2025" min="2000" max="2030">
                    </div>
                </div>
                
                <div class="financial-tables">
                    <!-- الميزانية العمومية -->
                    <div class="table-container">
                        <div class="table-header">
                            <span>الميزانية العمومية</span>
                            <div class="table-actions">
                                <button type="button" class="btn btn-small" id="add-current-asset">+ أصل متداول</button>
                                <button type="button" class="btn btn-small" id="add-fixed-asset">+ أصل ثابت</button>
                                <button type="button" class="btn btn-small" id="add-liability">+ خصوم/ملكية</button>
                            </div>
                        </div>
                        <div class="table-scroll">
                            <table id="balance-sheet">
                                <thead>
                                    <tr>
                                        <th>البند</th>
                                        <th id="balance-year1">2024 (ج.م)</th>
                                        <th id="balance-year2">2025 (ج.م)</th>
                                        <th>إجراءات</th>
                                    </tr>
                                </thead>
                                <tbody id="balance-body">
                                    <tr class="section-header">
                                        <td colspan="4">الأصول المتداولة</td>
                                    </tr>
                                    <tr data-category="current-assets">
                                        <td><input type="text" class="item-name" value="النقدية" placeholder="اسم البند"></td>
                                        <td><input type="number" class="balance-input" data-year="year1" placeholder="0"></td>
                                        <td><input type="number" class="balance-input" data-year="year2" placeholder="0"></td>
                                        <td><button type="button" class="btn btn-danger btn-small remove-row">حذف</button></td>
                                    </tr>
                                    <tr data-category="current-assets">
                                        <td><input type="text" class="item-name" value="المخزون" placeholder="اسم البند"></td>
                                        <td><input type="number" class="balance-input" data-year="year1" placeholder="0"></td>
                                        <td><input type="number" class="balance-input" data-year="year2" placeholder="0"></td>
                                        <td><button type="button" class="btn btn-danger btn-small remove-row">حذف</button></td>
                                    </tr>
                                    <tr class="section-header">
                                        <td colspan="4">الأصول الثابتة</td>
                                    </tr>
                                    <tr data-category="fixed-assets">
                                        <td><input type="text" class="item-name" value="الأصول الثابتة" placeholder="اسم البند"></td>
                                        <td><input type="number" class="balance-input" data-year="year1" placeholder="0"></td>
                                        <td><input type="number" class="balance-input" data-year="year2" placeholder="0"></td>
                                        <td><button type="button" class="btn btn-danger btn-small remove-row">حذف</button></td>
                                    </tr>
                                    <tr class="section-header">
                                        <td colspan="4">الخصوم المتداولة</td>
                                    </tr>
                                    <tr data-category="current-liabilities">
                                        <td><input type="text" class="item-name" value="الديون قصيرة الأجل" placeholder="اسم البند"></td>
                                        <td><input type="number" class="balance-input" data-year="year1" placeholder="0"></td>
                                        <td><input type="number" class="balance-input" data-year="year2" placeholder="0"></td>
                                        <td><button type="button" class="btn btn-danger btn-small remove-row">حذف</button></td>
                                    </tr>
                                    <tr class="section-header">
                                        <td colspan="4">الخصوم طويلة الأجل</td>
                                    </tr>
                                    <tr data-category="long-liabilities">
                                        <td><input type="text" class="item-name" value="الديون طويلة الأجل" placeholder="اسم البند"></td>
                                        <td><input type="number" class="balance-input" data-year="year1" placeholder="0"></td>
                                        <td><input type="number" class="balance-input" data-year="year2" placeholder="0"></td>
                                        <td><button type="button" class="btn btn-danger btn-small remove-row">حذف</button></td>
                                    </tr>
                                    <tr class="section-header">
                                        <td colspan="4">حقوق الملكية</td>
                                    </tr>
                                    <tr data-category="equity">
                                        <td><input type="text" class="item-name" value="حقوق المساهمين" placeholder="اسم البند"></td>
                                        <td><input type="number" class="balance-input" data-year="year1" placeholder="0"></td>
                                        <td><input type="number" class="balance-input" data-year="year2" placeholder="0"></td>
                                        <td><button type="button" class="btn btn-danger btn-small remove-row">حذف</button></td>
                                    </tr>
                                    <!-- المجاميع -->
                                    <tr class="total-row">
                                        <td><strong>إجمالي الأصول</strong></td>
                                        <td id="total-assets-year1">0</td>
                                        <td id="total-assets-year2">0</td>
                                        <td></td>
                                    </tr>
                                    <tr class="total-row">
                                        <td><strong>إجمالي الخصوم وحقوق الملكية</strong></td>
                                        <td id="total-liabilities-equity-year1">0</td>
                                        <td id="total-liabilities-equity-year2">0</td>
                                        <td></td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                        <div class="balance-validation" id="balance-validation">
                            <div class="validation-message"></div>
                        </div>
                    </div>
                    
                    <!-- قائمة الدخل -->
                    <div class="table-container">
                        <div class="table-header">
                            <span>قائمة الدخل</span>
                            <div class="table-actions">
                                <button type="button" class="btn btn-small" id="add-income-item">+ إيرادات</button>
                                <button type="button" class="btn btn-small" id="add-expense-item">+ مصروفات</button>
                            </div>
                        </div>
                        <div class="table-scroll">
                            <table id="income-statement">
                                <thead>
                                    <tr>
                                        <th>البند</th>
                                        <th id="income-year1">2024 (ج.م)</th>
                                        <th id="income-year2">2025 (ج.م)</th>
                                        <th>إجراءات</th>
                                    </tr>
                                </thead>
                                <tbody id="income-body">
                                    <tr class="section-header">
                                        <td colspan="4">الإيرادات</td>
                                    </tr>
                                    <tr data-category="revenue">
                                        <td><input type="text" class="item-name" value="إيرادات المبيعات" placeholder="اسم البند"></td>
                                        <td><input type="number" class="income-input" data-year="year1" placeholder="0"></td>
                                        <td><input type="number" class="income-input" data-year="year2" placeholder="0"></td>
                                        <td><button type="button" class="btn btn-danger btn-small remove-row">حذف</button></td>
                                    </tr>
                                    <tr class="section-header">
                                        <td colspan="4">تكلفة الإيرادات</td>
                                    </tr>
                                    <tr data-category="cogs">
                                        <td><input type="text" class="item-name" value="تكلفة البضاعة المباعة" placeholder="اسم البند"></td>
                                        <td><input type="number" class="income-input" data-year="year1" placeholder="0"></td>
                                        <td><input type="number" class="income-input" data-year="year2" placeholder="0"></td>
                                        <td><button type="button" class="btn btn-danger btn-small remove-row">حذف</button></td>
                                    </tr>
                                    <tr class="calculated-row">
                                        <td><strong>مجمل الربح</strong></td>
                                        <td id="gross-profit-year1">0</td>
                                        <td id="gross-profit-year2">0</td>
                                        <td></td>
                                    </tr>
                                    <tr class="section-header">
                                        <td colspan="4">المصروفات التشغيلية</td>
                                    </tr>
                                    <tr data-category="expenses">
                                        <td><input type="text" class="item-name" value="المصروفات التشغيلية" placeholder="اسم البند"></td>
                                        <td><input type="number" class="income-input" data-year="year1" placeholder="0"></td>
                                        <td><input type="number" class="income-input" data-year="year2" placeholder="0"></td>
                                        <td><button type="button" class="btn btn-danger btn-small remove-row">حذف</button></td>
                                    </tr>
                                    <tr class="calculated-row">
                                        <td><strong>الربح التشغيلي</strong></td>
                                        <td id="operating-profit-year1">0</td>
                                        <td id="operating-profit-year2">0</td>
                                        <td></td>
                                    </tr>
                                    <tr class="section-header">
                                        <td colspan="4">الإيرادات والمصروفات الأخرى</td>
                                    </tr>
                                    <tr data-category="other">
                                        <td><input type="text" class="item-name" value="الفوائد" placeholder="اسم البند"></td>
                                        <td><input type="number" class="income-input" data-year="year1" placeholder="0"></td>
                                        <td><input type="number" class="income-input" data-year="year2" placeholder="0"></td>
                                        <td><button type="button" class="btn btn-danger btn-small remove-row">حذف</button></td>
                                    </tr>
                                    <tr class="calculated-row total-row">
                                        <td><strong>صافي الربح</strong></td>
                                        <td id="net-profit-year1">0</td>
                                        <td id="net-profit-year2">0</td>
                                        <td></td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
                
                <button type="submit" class="btn btn-large">تحليل البيانات</button>
            </form>
        </section>

        <section id="analysis-controls" class="analysis-controls" style="display: none;">
            <h2 class="section-title">نوع التحليل</h2>
            <div class="analysis-buttons">
                <button class="btn analysis-btn active" data-analysis="vertical">التحليل الرأسي</button>
                <button class="btn analysis-btn" data-analysis="horizontal">التحليل الأفقي</button>
                <button class="btn analysis-btn" data-analysis="ratios">النسب المالية</button>
            </div>
        </section>

        <section id="results" class="results-section" style="display: none;">
            <h2 class="section-title">نتائج التحليل المالي</h2>
            <div class="results-container" id="results-container">
                <!-- سيتم ملء هذا القسم بالنتائج ديناميكيًا -->
            </div>
        </section>

        <!-- قسم التحليل الإضافي -->
        <section id="additional-analysis" class="analysis-controls" style="display: none;">
            <h2 class="section-title">تحليلات إضافية</h2>
            <div class="analysis-buttons">
                <button class="btn analysis-btn" data-analysis="liquidity-ratios">تحليل النسب</button>
                <button class="btn analysis-btn" data-analysis="cash-flow">قائمة المصادر والاستخدامات</button>
            </div>
        </section>

        <section id="additional-results" class="results-section" style="display: none;">
            <h2 class="section-title">نتائج التحليل الإضافية</h2>
            <div class="results-container" id="additional-results-container">
                <!-- سيتم ملء هذا القسم بالنتائج ديناميكيًا -->
            </div>
        </section>
    </div>

    <footer>
        <div class="container footer-content">
            <div class="logo">AFA</div>
            <div class="footer-links">
                <a href="#">الخصوصية</a>
                <a href="#">الشروط</a>
                <a href="#">اتصل بنا</a>
                <a href="#">المساعدة</a>
            </div>
            <p>جميع الحقوق محفوظة &copy; 2023 AFA - موقع تحليل القوائم المالية</p>
        </div>
    </footer>

    <script>
        // تفعيل القائمة المتنقلة
        document.addEventListener('DOMContentLoaded', function() {
            const mobileMenuBtn = document.getElementById('mobile-menu-btn');
            const navMenu = document.getElementById('nav-menu');
            
            if (mobileMenuBtn) {
                mobileMenuBtn.addEventListener('click', function() {
                    navMenu.classList.toggle('show');
                });
            }
            
            // إغلاق القائمة عند النقر خارجها
            document.addEventListener('click', function(e) {
                if (!e.target.closest('nav') && navMenu.classList.contains('show')) {
                    navMenu.classList.remove('show');
                }
            });
            
            // تحديث السنوات في الجداول
            document.getElementById('year1').addEventListener('input', updateYearHeaders);
            document.getElementById('year2').addEventListener('input', updateYearHeaders);
            
            // تحديث الحسابات تلقائياً عند تغيير القيم
            document.addEventListener('input', updateCalculations);
            
            // إضافة أحداث لأزرار الإضافة
            setupAddButtons();
            
            // تحديث الحسابات الأولي
            updateYearHeaders();
            updateCalculations();
        });

        // إعداد أزرار الإضافة
        function setupAddButtons() {
            // إضافة أصول متداولة
            document.getElementById('add-current-asset').addEventListener('click', function() {
                addBalanceItem('current-assets', 'الأصول المتداولة');
            });

            // إضافة أصول ثابتة
            document.getElementById('add-fixed-asset').addEventListener('click', function() {
                addBalanceItem('fixed-assets', 'الأصول الثابتة');
            });

            // إضافة خصوم أو حقوق ملكية
            document.getElementById('add-liability').addEventListener('click', function() {
                const type = prompt('اختر نوع الإضافة:\n1- الخصوم المتداولة\n2- الخصوم طويلة الأجل\n3- حقوق الملكية', '1');
                
                let category, section;
                if (type === '1') {
                    category = 'current-liabilities';
                    section = 'الخصوم المتداولة';
                } else if (type === '2') {
                    category = 'long-liabilities';
                    section = 'الخصوم طويلة الأجل';
                } else if (type === '3') {
                    category = 'equity';
                    section = 'حقوق الملكية';
                } else {
                    return;
                }
                
                addBalanceItem(category, section);
            });

            // إضافة إيرادات
            document.getElementById('add-income-item').addEventListener('click', function() {
                addIncomeItem('revenue', 'الإيرادات');
            });

            // إضافة مصروفات
            document.getElementById('add-expense-item').addEventListener('click', function() {
                const type = prompt('اختر نوع المصروفات:\n1- تكلفة الإيرادات\n2- المصروفات التشغيلية\n3- إيرادات/مصروفات أخرى', '2');
                
                let category, section;
                if (type === '1') {
                    category = 'cogs';
                    section = 'تكلفة الإيرادات';
                } else if (type === '2') {
                    category = 'expenses';
                    section = 'المصروفات التشغيلية';
                } else if (type === '3') {
                    category = 'other';
                    section = 'الإيرادات والمصروفات الأخرى';
                } else {
                    return;
                }
                
                addIncomeItem(category, section);
            });
        }

        // تحديث عناوين السنوات في الجداول
        function updateYearHeaders() {
            const year1 = document.getElementById('year1').value;
            const year2 = document.getElementById('year2').value;
            
            document.getElementById('balance-year1').textContent = `${year1} (ج.م)`;
            document.getElementById('balance-year2').textContent = `${year2} (ج.م)`;
            document.getElementById('income-year1').textContent = `${year1} (ج.م)`;
            document.getElementById('income-year2').textContent = `${year2} (ج.م)`;
        }

        // دالة مساعدة لإضافة بنود الميزانية
        function addBalanceItem(category, sectionName) {
            const table = document.getElementById('balance-body');
            let insertIndex = -1;
            
            // البحث عن مكان الإدراج بناءً على القسم
            for (let i = 0; i < table.rows.length; i++) {
                if (table.rows[i].classList.contains('section-header') && 
                    table.rows[i].cells[0].textContent === sectionName) {
                    // البحث عن آخر صف في هذا القسم
                    for (let j = i + 1; j < table.rows.length; j++) {
                        if (table.rows[j].classList.contains('section-header') || 
                            table.rows[j].classList.contains('total-row')) {
                            insertIndex = j;
                            break;
                        }
                    }
                    if (insertIndex === -1) insertIndex = table.rows.length - 2; // قبل المجاميع
                    break;
                }
            }
            
            if (insertIndex === -1) return;
            
            const newRow = table.insertRow(insertIndex);
            newRow.setAttribute('data-category', category);
            
            const itemNameCell = newRow.insertCell(0);
            const inputYear1Cell = newRow.insertCell(1);
            const inputYear2Cell = newRow.insertCell(2);
            const actionsCell = newRow.insertCell(3);
            
            const itemNameInput = document.createElement('input');
            itemNameInput.type = 'text';
            itemNameInput.className = 'item-name';
            itemNameInput.placeholder = 'اسم البند';
            itemNameInput.value = 'بند جديد';
            itemNameInput.addEventListener('input', updateCalculations);
            itemNameCell.appendChild(itemNameInput);
            
            const inputYear1 = document.createElement('input');
            inputYear1.type = 'number';
            inputYear1.placeholder = '0';
            inputYear1.className = 'balance-input';
            inputYear1.setAttribute('data-year', 'year1');
            inputYear1.addEventListener('input', updateCalculations);
            inputYear1Cell.appendChild(inputYear1);
            
            const inputYear2 = document.createElement('input');
            inputYear2.type = 'number';
            inputYear2.placeholder = '0';
            inputYear2.className = 'balance-input';
            inputYear2.setAttribute('data-year', 'year2');
            inputYear2.addEventListener('input', updateCalculations);
            inputYear2Cell.appendChild(inputYear2);
            
            const removeButton = document.createElement('button');
            removeButton.type = 'button';
            removeButton.className = 'btn btn-danger btn-small remove-row';
            removeButton.textContent = 'حذف';
            removeButton.addEventListener('click', function() {
                table.deleteRow(newRow.rowIndex);
                updateCalculations();
            });
            actionsCell.appendChild(removeButton);
            
            updateCalculations();
        }

        // دالة مساعدة لإضافة بنود قائمة الدخل
        function addIncomeItem(category, sectionName) {
            const table = document.getElementById('income-body');
            let insertIndex = -1;
            
            // البحث عن مكان الإدراج بناءً على القسم
            for (let i = 0; i < table.rows.length; i++) {
                if (table.rows[i].classList.contains('section-header') && 
                    table.rows[i].cells[0].textContent === sectionName) {
                    // البحث عن آخر صف في هذا القسم
                    for (let j = i + 1; j < table.rows.length; j++) {
                        if (table.rows[j].classList.contains('section-header') || 
                            table.rows[j].classList.contains('calculated-row')) {
                            insertIndex = j;
                            break;
                        }
                    }
                    if (insertIndex === -1) insertIndex = table.rows.length - 1; // قبل الصف الأخير
                    break;
                }
            }
            
            if (insertIndex === -1) return;
            
            const newRow = table.insertRow(insertIndex);
            newRow.setAttribute('data-category', category);
            
            const itemNameCell = newRow.insertCell(0);
            const inputYear1Cell = newRow.insertCell(1);
            const inputYear2Cell = newRow.insertCell(2);
            const actionsCell = newRow.insertCell(3);
            
            const itemNameInput = document.createElement('input');
            itemNameInput.type = 'text';
            itemNameInput.className = 'item-name';
            itemNameInput.placeholder = 'اسم البند';
            itemNameInput.value = 'بند جديد';
            itemNameInput.addEventListener('input', updateCalculations);
            itemNameCell.appendChild(itemNameInput);
            
            const inputYear1 = document.createElement('input');
            inputYear1.type = 'number';
            inputYear1.placeholder = '0';
            inputYear1.className = 'income-input';
            inputYear1.setAttribute('data-year', 'year1');
            inputYear1.addEventListener('input', updateCalculations);
            inputYear1Cell.appendChild(inputYear1);
            
            const inputYear2 = document.createElement('input');
            inputYear2.type = 'number';
            inputYear2.placeholder = '0';
            inputYear2.className = 'income-input';
            inputYear2.setAttribute('data-year', 'year2');
            inputYear2.addEventListener('input', updateCalculations);
            inputYear2Cell.appendChild(inputYear2);
            
            const removeButton = document.createElement('button');
            removeButton.type = 'button';
            removeButton.className = 'btn btn-danger btn-small remove-row';
            removeButton.textContent = 'حذف';
            removeButton.addEventListener('click', function() {
                table.deleteRow(newRow.rowIndex);
                updateCalculations();
            });
            actionsCell.appendChild(removeButton);
            
            updateCalculations();
        }

        // إضافة حدث لحذف الصفوف
        document.addEventListener('click', function(e) {
            if (e.target && e.target.classList.contains('remove-row')) {
                const row = e.target.closest('tr');
                row.parentNode.removeChild(row);
                updateCalculations();
            }
        });

        // تحديث الحسابات التلقائية
        function updateCalculations() {
            calculateBalanceSheet();
            calculateIncomeStatement();
            validateBalanceSheet();
        }

        // حساب الميزانية العمومية
        function calculateBalanceSheet() {
            const categories = {
                'current-assets': { year1: 0, year2: 0 },
                'fixed-assets': { year1: 0, year2: 0 },
                'current-liabilities': { year1: 0, year2: 0 },
                'long-liabilities': { year1: 0, year2: 0 },
                'equity': { year1: 0, year2: 0 }
            };
            
            // جمع قيم كل فئة
            document.querySelectorAll('#balance-body tr[data-category]').forEach(row => {
                const category = row.getAttribute('data-category');
                const year1Input = row.querySelector('input[data-year="year1"]');
                const year2Input = row.querySelector('input[data-year="year2"]');
                
                if (year1Input) {
                    categories[category].year1 += parseFloat(year1Input.value) || 0;
                }
                if (year2Input) {
                    categories[category].year2 += parseFloat(year2Input.value) || 0;
                }
            });
            
            // حساب الإجماليات
            const totalAssetsYear1 = categories['current-assets'].year1 + categories['fixed-assets'].year1;
            const totalAssetsYear2 = categories['current-assets'].year2 + categories['fixed-assets'].year2;
            
            const totalLiabilitiesEquityYear1 = categories['current-liabilities'].year1 + 
                                              categories['long-liabilities'].year1 + 
                                              categories['equity'].year1;
            
            const totalLiabilitiesEquityYear2 = categories['current-liabilities'].year2 + 
                                              categories['long-liabilities'].year2 + 
                                              categories['equity'].year2;
            
            // تحديث القيم في الجدول
            document.getElementById('total-assets-year1').textContent = formatNumber(totalAssetsYear1);
            document.getElementById('total-assets-year2').textContent = formatNumber(totalAssetsYear2);
            document.getElementById('total-liabilities-equity-year1').textContent = formatNumber(totalLiabilitiesEquityYear1);
            document.getElementById('total-liabilities-equity-year2').textContent = formatNumber(totalLiabilitiesEquityYear2);
        }

        // حساب قائمة الدخل
        function calculateIncomeStatement() {
            const categories = {
                'revenue': { year1: 0, year2: 0 },
                'cogs': { year1: 0, year2: 0 },
                'expenses': { year1: 0, year2: 0 },
                'other': { year1: 0, year2: 0 }
            };
            
            // جمع قيم كل فئة
            document.querySelectorAll('#income-body tr[data-category]').forEach(row => {
                const category = row.getAttribute('data-category');
                const year1Input = row.querySelector('input[data-year="year1"]');
                const year2Input = row.querySelector('input[data-year="year2"]');
                
                if (year1Input) {
                    categories[category].year1 += parseFloat(year1Input.value) || 0;
                }
                if (year2Input) {
                    categories[category].year2 += parseFloat(year2Input.value) || 0;
                }
            });
            
            // حساب النتائج
            const grossProfitYear1 = categories['revenue'].year1 - categories['cogs'].year1;
            const grossProfitYear2 = categories['revenue'].year2 - categories['cogs'].year2;
            
            const operatingProfitYear1 = grossProfitYear1 - categories['expenses'].year1;
            const operatingProfitYear2 = grossProfitYear2 - categories['expenses'].year2;
            
            const netProfitYear1 = operatingProfitYear1 - categories['other'].year1;
            const netProfitYear2 = operatingProfitYear2 - categories['other'].year2;
            
            // تحديث القيم في الجدول
            document.getElementById('gross-profit-year1').textContent = formatNumber(grossProfitYear1);
            document.getElementById('gross-profit-year2').textContent = formatNumber(grossProfitYear2);
            document.getElementById('operating-profit-year1').textContent = formatNumber(operatingProfitYear1);
            document.getElementById('operating-profit-year2').textContent = formatNumber(operatingProfitYear2);
            document.getElementById('net-profit-year1').textContent = formatNumber(netProfitYear1);
            document.getElementById('net-profit-year2').textContent = formatNumber(netProfitYear2);
        }

        // التحقق من توازن الميزانية
        function validateBalanceSheet() {
            const totalAssetsYear1 = parseFloat(document.getElementById('total-assets-year1').textContent.replace(/,/g, '')) || 0;
            const totalAssetsYear2 = parseFloat(document.getElementById('total-assets-year2').textContent.replace(/,/g, '')) || 0;
            
            const totalLiabilitiesEquityYear1 = parseFloat(document.getElementById('total-liabilities-equity-year1').textContent.replace(/,/g, '')) || 0;
            const totalLiabilitiesEquityYear2 = parseFloat(document.getElementById('total-liabilities-equity-year2').textContent.replace(/,/g, '')) || 0;
            
            const validationElement = document.querySelector('#balance-validation .validation-message');
            
            const diffYear1 = Math.abs(totalAssetsYear1 - totalLiabilitiesEquityYear1);
            const diffYear2 = Math.abs(totalAssetsYear2 - totalLiabilitiesEquityYear2);
            
            if (diffYear1 <= 1 && diffYear2 <= 1) {
                validationElement.textContent = '✓ الميزانية متوازنة';
                validationElement.className = 'validation-message validation-success';
            } else {
                validationElement.textContent = `! الميزانية غير متوازنة - الفرق: ${formatNumber(diffYear1)} (السنة الأولى) - ${formatNumber(diffYear2)} (السنة الثانية)`;
                validationElement.className = 'validation-message validation-error';
            }
        }

        // تنسيق الأرقام
        function formatNumber(num) {
            return new Intl.NumberFormat('ar-EG').format(Math.round(num * 100) / 100);
        }

        // معالجة نموذج التحليل
        document.getElementById('financial-data-form').addEventListener('submit', function(e) {
            e.preventDefault();
            
            // جمع البيانات
            const financialData = collectFinancialData();
            
            // عرض عناصر التحكم
            document.getElementById('analysis-controls').style.display = 'block';
            document.getElementById('results').style.display = 'block';
            document.getElementById('additional-analysis').style.display = 'block';
            document.getElementById('additional-results').style.display = 'block';
            
            // إعداد أحداث أزرار التحليل
            setupAnalysisButtons(financialData);
            setupAdditionalAnalysisButtons(financialData);
            
            // عرض التحليل الافتراضي (الرأسي)
            showVerticalAnalysis(financialData);
            
            // التمرير إلى قسم النتائج
            document.getElementById('results').scrollIntoView({ behavior: 'smooth' });
        });

        // جمع البيانات المالية
        function collectFinancialData() {
            const data = {
                companyName: document.getElementById('company-name').value,
                year1: document.getElementById('year1').value,
                year2: document.getElementById('year2').value,
                balanceSheet: {},
                incomeStatement: {},
                // إضافة بيانات إضافية
                inventory: { year1: 0, year2: 0 },
                cash: { year1: 0, year2: 0 }
            };
            
            // جمع بيانات الميزانية العمومية
            document.querySelectorAll('#balance-body tr[data-category]').forEach(row => {
                const category = row.getAttribute('data-category');
                const itemName = row.querySelector('.item-name').value || 'بند بدون اسم';
                const year1Value = parseFloat(row.querySelector('input[data-year="year1"]').value) || 0;
                const year2Value = parseFloat(row.querySelector('input[data-year="year2"]').value) || 0;
                
                if (!data.balanceSheet[category]) {
                    data.balanceSheet[category] = {};
                }
                
                data.balanceSheet[category][itemName] = {
                    year1: year1Value,
                    year2: year2Value
                };
                
                // البحث عن المخزون والنقدية
                if (category === 'current-assets') {
                    if (itemName.includes('مخزون') || itemName.includes('بضاعة') || itemName.includes('المخزون')) {
                        data.inventory.year1 = year1Value;
                        data.inventory.year2 = year2Value;
                    }
                    
                    if (itemName.includes('نقدي') || itemName.includes('النقدية') || itemName.includes('الصندوق')) {
                        data.cash.year1 = year1Value;
                        data.cash.year2 = year2Value;
                    }
                }
            });
            
            // جمع بيانات قائمة الدخل
            document.querySelectorAll('#income-body tr[data-category]').forEach(row => {
                const category = row.getAttribute('data-category');
                const itemName = row.querySelector('.item-name').value || 'بند بدون اسم';
                const year1Value = parseFloat(row.querySelector('input[data-year="year1"]').value) || 0;
                const year2Value = parseFloat(row.querySelector('input[data-year="year2"]').value) || 0;
                
                if (!data.incomeStatement[category]) {
                    data.incomeStatement[category] = {};
                }
                
                data.incomeStatement[category][item
